<!DOCTYPE html>
<html>
<head>
    <title>
        Canvas Render
    </title>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.css">
    <link rel="stylesheet" type="text/css" href="css/home.css">

    <script type="text/javascript" src="js/lib/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/lib/StackBlur.js"></script>
    <script type="text/javascript" src="js/lib/Stats.js"></script>

    <script type="text/javascript" src="js/modules/utility/class.js"></script>
    <script type="text/javascript" src="js/modules/utility/linkedlist.js"></script>
    <script type="text/javascript" src="js/modules/utility/EventManager.js"></script>
    <script type="text/javascript" src="js/modules/utility/general.js"></script>
    <script type="text/javascript" src="js/modules/utility/array.js"></script>
    <script type="text/javascript" src="js/modules/utility/string.js"></script>
    <script type="text/javascript" src="js/modules/utility/graphics.js"></script>
    <script type="text/javascript" src="js/modules/stage.js"></script>
    <script type="text/javascript" src="js/modules/layer.js"></script>
    <script type="text/javascript" src="js/modules/render.js"></script>
    <script type="text/javascript" src="js/modules/filters.js"></script>
    <script type="text/javascript" src="js/modules/transition.js"></script>
    <script type="text/javascript" src="js/modules/shapes/shape.js"></script>
    <script type="text/javascript" src="js/modules/shapes/line.js"></script>
    <script type="text/javascript" src="js/modules/shapes/image.js"></script>
    <script type="text/javascript" src="js/modules/shapes/arc.js"></script>
    <script type="text/javascript" src="js/modules/shapes/rectangle.js"></script>
    <script type="text/javascript" src="js/modules/shapes/sprite.js"></script>
    <script type="text/javascript" src="js/modules/animation.js"></script>
</head>
<body>
    <div id="viewport">
    </div>
    <script>
        function transition(layer) {
            //
            //In kg
            var m1 = 2;
            var m2 = 0.5;
            //
            //In pixel/s
            var v1 = new RenderJs.Vector(377.95275591, 0);
            var v2 = new RenderJs.Vector(-377.795275591, 0);
            var circle1 = new RenderJs.Canvas.Shapes.Arc({
                x: 0,
                y: 280,
                radius: 100,
                sAngle: 0,
                eAngle: 360,
                fillColor: "#333",
                collision: true
            });
            circle1.v = v1;
            circle1.pos = new RenderJs.Vector(0, 280);
            circle1.prevPos = new RenderJs.Vector(0, 280);
            var circle2 = new RenderJs.Canvas.Shapes.Arc({
                x: 1150,
                y: 250,
                radius: 25,
                sAngle: 0,
                eAngle: 360,
                fillColor: "green",
                collision: true
            });
            circle2.v = v2;
            circle1.w1 = 0;
            circle2.w2 = 0;
            layer.addShape(circle1);
            layer.addShape(circle2);
            circle1.on("collision", function () {
                //
                //Perfectly unelastic movement
                var n = new RenderJs.Vector(circle2.getCenter().x - circle1.getCenter().x, circle2.getCenter().y - circle1.getCenter().y);
                var un = new RenderJs.Vector(n.x / Math.sqrt(Math.pow(n.x, 2) + Math.pow(n.y, 2)), n.y / Math.sqrt(Math.pow(n.x, 2) + Math.pow(n.y, 2)));
                var ut = new RenderJs.Vector(-un.y, un.x);
                var v1n = un.dot(v1);
                var v2n = un.dot(v2);
                var v1t = ut.dot(v1);
                var v2t = ut.dot(v2);

                var v11n = ((m1 - m2) * v1n + (2 * m2 * v2n)) / (m1 + m2);
                var vv1n = un.scale(v11n);
                var vv1t = ut.scale(v1t);
                circle1.v = vv1n.add(vv1t);

                //
                //Angular velocity
                var r = Math.abs(circle1.getCenter().y - circle2.getCenter().y);
                var l = (m1 + (m2 / 3)) * Math.pow(circle1.radius, 2);
                circle1.w1 = (m1 * v1.length() * circle1.radius) / l;
                console.log("Angular velocity 1:", circle1.w1);
                //console.log("Angular velocity 2:", w2);


            });
            circle2.on("collision", function () {
                var n = new RenderJs.Vector(circle2.getCenter().x - circle1.getCenter().x, circle2.getCenter().y - circle1.getCenter().y);
                var un = new RenderJs.Vector(n.x / Math.sqrt(Math.pow(n.x, 2) + Math.pow(n.y, 2)), n.y / Math.sqrt(Math.pow(n.x, 2) + Math.pow(n.y, 2)));
                var ut = new RenderJs.Vector(-un.y, un.x);
                var v1n = un.dot(v1);
                var v2n = un.dot(v2);
                var v1t = ut.dot(v1);
                var v2t = ut.dot(v2);

                var v22n = ((m2 - m1) * v2n + (2 * m1 * v1n)) / (m1 + m2);
                var vv2n = un.scale(v22n);
                var vv2t = ut.scale(v2t);
                circle2.v = vv2n.add(vv2t);

                var r = Math.abs(circle1.getCenter().y - circle2.getCenter().y);
                var l = (m1 + (m2 / 3)) * Math.pow(circle2.radius, 2);
                circle2.w2 = (m1 * v2.length() * circle2.radius) / l;
                console.log("Angular velocity 2:", circle2.w2);
            });
            var anim = new RenderJs.Canvas.Animation(function (frame) {
                //Gravity ((9.78049 / 2) * Math.pow(frame.time / 1000, 2));

                //r * (Math.sin(Utils.convertToRad(img.aangle))) + ox, r * (Math.cos(Utils.convertToRad(img.aangle))) + oy)
                var acc = new RenderJs.Vector(0, 0.1);
                var newPos = circle1.pos.scale(2).sub(circle1.prevPos).add(acc);
                //circle1.prevPos.set(circle1.pos);
                //circle1.pos.set(newPos);
                circle1.pos = circle1.pos.add(circle1.v.scale((frame.time - frame.lastTime) / 1000));
                circle2.pos = circle2.pos.add(circle2.v.scale((frame.time - frame.lastTime) / 1000));

                circle1.angle += (circle1.w1 / (Math.PI / 180)) * ((frame.time - frame.lastTime) / 1000);
                circle2.angle += (circle2.w2 / (Math.PI / 180)) * ((frame.time - frame.lastTime) / 1000);
            }, layer);
            anim.start();
        }

        function sprite(llayer) {
            var test = new RenderJs.Canvas.Shapes.Sprite({
                url: "images/blob-sprite.png",
                x: 100,
                y: 100,
                collision: true,
                defAnimation: "idle",
                animations: {
                    idle: [
                        2, 2, 70, 119,
                        71, 2, 74, 119,
                        146, 2, 81, 119,
                        226, 2, 76, 119
                    ],
                    punch: [
                        2, 138, 74, 122,
                        76, 138, 84, 122,
                        346, 138, 120, 122
                    ]
                },
                frameCount: 7
            });
            llayer.addShape(test);
            test.start();
            $(document).click(function () {
                test.animation("punch");
            });
        }

        var stage = new RenderJs.Canvas.Stage({
            container: "viewport",
            width: 1200,
            height: 800
        });
        var animlayer = stage.createLayer("AnimLayer");
        var staticlayer = stage.createLayer("StaticLayer");
        transition(animlayer);
        //sprite(staticlayer);
    </script>
    <script type="text/javascript" src="js/lib/underscore-min.js"></script>
    <script type="text/javascript" src="js/lib/knockout-3.1.0.js"></script>

    <script type="text/javascript" src="js/main.js"></script>

</body>
</html>